require File.expand_path '../spec_helper.rb', __FILE__

describe 'App' do
  describe 'Post /sem' do
    before { post '/sem', params, { 'CONTENT_TYPE' => 'application/json', 'ACCEPT' => 'application/json' } }

    context 'データセット: PoliticalDemocracy' do
      let(:params) {
        {
          nobs: 75,
          obs_names: %w(y1 y2 y3 y4 y5 y6 y7 y8 x1 x2 x3),
          cov: [
            [6.8785658],
            [6.2513659, 15.5798162],
            [5.8388354, 5.8386258, 10.7642473],
            [6.0886427, 9.5085534, 6.687937, 11.218932],
            [5.0638108, 5.6030723, 4.9390271, 5.702059, 6.82569],
            [5.7458262, 9.3862893, 4.7273963, 7.442182, 4.976805, 11.3753251],
            [5.8119432, 7.5354623, 7.0064347, 7.487999, 5.821366, 6.748119, 10.7993719],
            [5.6710576, 7.7582132, 5.6391391, 8.012646, 5.339386, 8.2468297, 7.5924331, 10.533872],
            [0.734393, 0.6194955, 0.7868787, 1.150461, 1.081626, 0.8527889, 0.9368373, 1.102881, 0.5371487],
            [1.2733939, 1.4912729, 1.5519351, 2.240957, 2.063733, 1.8054863, 1.9955952, 2.234237, 0.9903611, 2.282107],
            [0.9114547, 1.1698131, 1.0390796, 1.838023, 1.583465, 1.5720662, 1.6259535, 1.692157, 0.823424, 1.8060906, 1.9760241]
          ],
          model: {
            latent_variable: {
              ind60: ['x1', 'x2', 'x3'],
              dem60: ['y1', 'y2', 'y3', 'y4'],
              dem65: ['y5', 'y6', 'y7', 'y8']
            },
            regression: {
              dem60: ['ind60'],
              dem65: ['ind60', 'dem60']
            },
            covariance: {
              y1: ['y5'],
              y2: ['y4', 'y6'],
              y3: ['y7'],
              y4: ['y8'],
              y6: ['y8']
            }
          }
        }.to_json
      }
      it '正常なレスポンスが返ること' do
        expect(last_response).to be_ok
        expect(last_response.body).to eq "{\"latent_variables\":{\"ind60\":[{\"name\":\"x1\",\"Estimate\":\"1.000\",\"Std.Err\":\"\",\"Z-value\":\"\",\"P(>|z|)\":\"\"},{\"name\":\"x2\",\"Estimate\":\"2.180\",\"Std.Err\":\"0.139\",\"Z-value\":\"15.742\",\"P(>|z|)\":\"0.000\"},{\"name\":\"x3\",\"Estimate\":\"1.819\",\"Std.Err\":\"0.152\",\"Z-value\":\"11.967\",\"P(>|z|)\":\"0.000\"}],\"dem60\":[{\"name\":\"y1\",\"Estimate\":\"1.000\",\"Std.Err\":\"\",\"Z-value\":\"\",\"P(>|z|)\":\"\"},{\"name\":\"y2\",\"Estimate\":\"1.257\",\"Std.Err\":\"0.182\",\"Z-value\":\"6.889\",\"P(>|z|)\":\"0.000\"},{\"name\":\"y3\",\"Estimate\":\"1.058\",\"Std.Err\":\"0.151\",\"Z-value\":\"6.987\",\"P(>|z|)\":\"0.000\"},{\"name\":\"y4\",\"Estimate\":\"1.265\",\"Std.Err\":\"0.145\",\"Z-value\":\"8.722\",\"P(>|z|)\":\"0.000\"}],\"dem65\":[{\"name\":\"y5\",\"Estimate\":\"1.000\",\"Std.Err\":\"\",\"Z-value\":\"\",\"P(>|z|)\":\"\"},{\"name\":\"y6\",\"Estimate\":\"1.186\",\"Std.Err\":\"0.169\",\"Z-value\":\"7.024\",\"P(>|z|)\":\"0.000\"},{\"name\":\"y7\",\"Estimate\":\"1.280\",\"Std.Err\":\"0.160\",\"Z-value\":\"8.002\",\"P(>|z|)\":\"0.000\"},{\"name\":\"y8\",\"Estimate\":\"1.266\",\"Std.Err\":\"0.158\",\"Z-value\":\"8.007\",\"P(>|z|)\":\"0.000\"}]},\"regressions\":{\"dem60\":[{\"name\":\"ind60\",\"Estimate\":\"1.483\",\"Std.Err\":\"0.399\",\"Z-value\":\"3.715\",\"P(>|z|)\":\"0.000\"}],\"dem65\":[{\"name\":\"ind60\",\"Estimate\":\"0.572\",\"Std.Err\":\"0.221\",\"Z-value\":\"2.586\",\"P(>|z|)\":\"0.010\"},{\"name\":\"dem60\",\"Estimate\":\"0.837\",\"Std.Err\":\"0.098\",\"Z-value\":\"8.514\",\"P(>|z|)\":\"0.000\"}]},\"covariances\":{\"y1\":[{\"name\":\"y5\",\"Estimate\":\"0.624\",\"Std.Err\":\"0.358\",\"Z-value\":\"1.741\",\"P(>|z|)\":\"0.082\"}],\"y2\":[{\"name\":\"y4\",\"Estimate\":\"1.313\",\"Std.Err\":\"0.702\",\"Z-value\":\"1.871\",\"P(>|z|)\":\"0.061\"},{\"name\":\"y6\",\"Estimate\":\"2.153\",\"Std.Err\":\"0.734\",\"Z-value\":\"2.934\",\"P(>|z|)\":\"0.003\"}],\"y3\":[{\"name\":\"y7\",\"Estimate\":\"0.795\",\"Std.Err\":\"0.608\",\"Z-value\":\"1.308\",\"P(>|z|)\":\"0.191\"}],\"y4\":[{\"name\":\"y8\",\"Estimate\":\"0.348\",\"Std.Err\":\"0.442\",\"Z-value\":\"0.787\",\"P(>|z|)\":\"0.431\"}],\"y6\":[{\"name\":\"y8\",\"Estimate\":\"1.356\",\"Std.Err\":\"0.568\",\"Z-value\":\"2.386\",\"P(>|z|)\":\"0.017\"}]},\"variances\":{\"x1\":{\"Estimate\":\"0.082\",\"Std.Err\":\"0.019\",\"Z-value\":\"4.184\",\"P(>|z|)\":\"0.000\"},\"x2\":{\"Estimate\":\"0.120\",\"Std.Err\":\"0.070\",\"Z-value\":\"1.718\",\"P(>|z|)\":\"0.086\"},\"x3\":{\"Estimate\":\"0.467\",\"Std.Err\":\"0.090\",\"Z-value\":\"5.177\",\"P(>|z|)\":\"0.000\"},\"y1\":{\"Estimate\":\"1.891\",\"Std.Err\":\"0.444\",\"Z-value\":\"4.256\",\"P(>|z|)\":\"0.000\"},\"y2\":{\"Estimate\":\"7.373\",\"Std.Err\":\"1.374\",\"Z-value\":\"5.366\",\"P(>|z|)\":\"0.000\"},\"y3\":{\"Estimate\":\"5.067\",\"Std.Err\":\"0.952\",\"Z-value\":\"5.324\",\"P(>|z|)\":\"0.000\"},\"y4\":{\"Estimate\":\"3.148\",\"Std.Err\":\"0.739\",\"Z-value\":\"4.261\",\"P(>|z|)\":\"0.000\"},\"y5\":{\"Estimate\":\"2.351\",\"Std.Err\":\"0.480\",\"Z-value\":\"4.895\",\"P(>|z|)\":\"0.000\"},\"y6\":{\"Estimate\":\"4.954\",\"Std.Err\":\"0.914\",\"Z-value\":\"5.419\",\"P(>|z|)\":\"0.000\"},\"y7\":{\"Estimate\":\"3.431\",\"Std.Err\":\"0.713\",\"Z-value\":\"4.814\",\"P(>|z|)\":\"0.000\"},\"y8\":{\"Estimate\":\"3.254\",\"Std.Err\":\"0.695\",\"Z-value\":\"4.685\",\"P(>|z|)\":\"0.000\"},\"ind60\":{\"Estimate\":\"0.448\",\"Std.Err\":\"0.087\",\"Z-value\":\"5.173\",\"P(>|z|)\":\"0.000\"},\"dem60\":{\"Estimate\":\"3.956\",\"Std.Err\":\"0.921\",\"Z-value\":\"4.295\",\"P(>|z|)\":\"0.000\"},\"dem65\":{\"Estimate\":\"0.172\",\"Std.Err\":\"0.215\",\"Z-value\":\"0.803\",\"P(>|z|)\":\"0.422\"}},\"goodness_of_fit\":{\"npar\":\"31.000\",\"fmin\":\"0.254\",\"chisq\":\"38.125\",\"df\":\"35.000\",\"pvalue\":\"0.329\",\"baseline.chisq\":\"730.654\",\"baseline.df\":\"55.000\",\"baseline.pvalue\":\"0.000\",\"cfi\":\"0.995\",\"tli\":\"0.993\",\"nnfi\":\"0.993\",\"rfi\":\"0.918\",\"nfi\":\"0.948\",\"pnfi\":\"0.603\",\"ifi\":\"0.996\",\"rni\":\"0.995\",\"logl\":\"-1547.791\",\"unrestricted.logl\":\"-1528.728\",\"aic\":\"3157.582\",\"bic\":\"3229.424\",\"ntotal\":\"75.000\",\"bic2\":\"3131.720\",\"rmsea\":\"0.035\",\"rmsea.ci.lower\":\"0.000\",\"rmsea.ci.upper\":\"0.092\",\"rmsea.pvalue\":\"0.611\",\"rmr\":\"0.276\",\"rmr_nomean\":\"0.276\",\"srmr\":\"0.044\",\"srmr_bentler\":\"0.044\",\"srmr_bentler_nomean\":\"0.044\",\"srmr_bollen\":\"0.045\",\"srmr_bollen_nomean\":\"0.045\",\"srmr_mplus\":\"0.045\",\"srmr_mplus_nomean\":\"0.045\",\"cn_05\":\"98.970\",\"cn_01\":\"113.803\",\"gfi\":\"0.923\",\"agfi\":\"0.854\",\"pgfi\":\"0.489\",\"mfi\":\"0.979\",\"ecvi\":\"1.335\"},\"obs_names\":[\"y1\",\"y2\",\"y3\",\"y4\",\"y5\",\"y6\",\"y7\",\"y8\",\"x1\",\"x2\",\"x3\"]}"
      end
    end
  end
end

