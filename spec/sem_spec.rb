require File.expand_path '../spec_helper.rb', __FILE__

describe Sem do
  let(:model) do
    {
      latent_variable: {
        f6: ['v0', 'v1', 'v2', 'v3'],
        f7: ['v4', 'v5']
      },
      regression: {
        f7: ['f6']
      }
    }
  end

  describe 'build_model' do
    let(:model_s) { Sem.build_model_s(model) }
    it do
      expect(model_s).to eq "f6 =~ v0 + v1 + v2 + v3\nf7 =~ v4 + v5\nf7 ~ f6\n"
    end
  end

  describe 'calc_cov' do
    let(:data) do
      {
        y1: [2.5, 1.25, 7.5, 8.9, 10.0, 7.5, 7.5, 7.5, 2.5, 10.0, 7.5, 7.5, 7.5, 7.5, 7.5, 7.5, 2.5, 1.25, 10.0, 7.5, 10.0, 1.25, 2.5, 7.5, 8.5, 6.1, 3.3, 2.9, 9.2, 6.9, 2.9, 2.0, 5.0, 5.0, 4.1, 6.3, 5.2, 5.0, 3.1, 4.1, 5.0, 5.0, 5.0, 5.6, 5.7, 7.5, 2.5, 8.9, 7.6, 7.8, 2.5, 3.8, 5.0, 6.25, 1.25, 1.25, 1.25, 7.5, 2.5, 7.5, 1.25, 1.25, 2.5, 6.25, 7.5, 5.0, 7.5, 4.9, 5.0, 2.9, 5.4, 7.5, 7.5, 10.0, 3.75],
        y2: [0.0, 0.0, 8.8, 8.8, 3.333333, 3.333333, 3.333333, 2.233333, 3.333333, 6.666666, 3.333333, 3.333333, 3.333333, 7.766664, 9.999998, 9.999998, 3.333333, 0.0, 9.999998, 3.333299, 9.999998, 0.0, 0.0, 6.666666, 9.999998, 0.0, 0.0, 3.333333, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 9.999998, 9.999998, 4.999998, 3.333333, 4.999998, 9.999998, 9.999998, 7.7, 6.2, 4.9, 4.8, 9.999998, 0.0, 9.999998, 0.0, 9.999998, 0.0, 0.0, 3.333333, 3.333333, 0.0, 0.0, 0.0, 7.766664, 0.0, 9.999998, 0.0, 0.0, 0.0, 2.233299, 9.999998, 0.0, 9.999998, 2.233333, 0.0, 3.333333, 9.999998, 8.8, 7.0, 6.666666, 3.333333],
        y3: [3.333333, 3.333333, 9.999998, 9.999998, 9.999998, 6.666666, 6.666666, 9.999998, 3.333333, 9.999998, 9.999998, 6.666666, 9.999998, 9.999998, 3.333333, 9.999998, 6.666666, 3.333333, 9.999998, 3.333333, 9.999998, 0.0, 3.333333, 9.999998, 6.666666, 5.4, 6.666666, 6.666666, 9.9, 6.666666, 3.333333, 0.0, 3.333333, 9.999998, 4.7, 9.999998, 6.6, 6.4, 4.2, 6.666666, 6.666666, 6.666666, 9.999998, 0.0, 0.0, 7.9, 6.666666, 9.7, 10.0, 6.666666, 6.666666, 5.1, 3.333333, 9.999998, 3.333333, 4.7, 6.666666, 9.999998, 6.666666, 9.999998, 0.0, 0.0, 0.0, 6.666666, 9.999998, 6.1, 9.999998, 9.999998, 8.2, 6.666666, 6.666666, 9.999998, 9.999998, 9.999998, 0.0],
        y4: [0.0, 0.0, 9.199991, 9.199991, 6.666666, 6.666666, 6.666666, 1.496333, 3.333333, 8.899991, 6.666666, 6.666666, 6.666666, 6.666666, 10.0, 7.766666, 6.666666, 3.333333, 10.0, 6.666666, 10.0, 0.0, 3.333333, 10.0, 6.666666, 3.333333, 3.333333, 3.333333, 3.333333, 3.333333, 3.333333, 0.0, 3.333333, 3.333333, 6.666666, 6.666666, 3.333333, 6.666666, 5.0, 3.333333, 1.666666, 8.399997, 6.060997, 0.0, 0.0, 6.666666, 3.333333, 6.666666, 0.0, 6.666666, 3.333333, 0.0, 2.233333, 2.955702, 0.0, 0.736999, 0.0, 6.666666, 4.433333, 10.0, 0.0, 0.0, 0.0, 2.970332, 10.0, 0.0, 10.0, 0.0, 0.0, 3.333333, 3.333333, 6.066666, 6.852998, 10.0, 0.0],
        y5: [1.25, 6.25, 8.75, 8.907948, 7.5, 6.25, 5.0, 6.25, 6.25, 8.75, 8.75, 8.75, 7.5, 7.5, 7.5, 7.5, 5.0, 1.25, 8.75, 7.5, 10.0, 2.5, 2.5, 7.5, 8.75, 0.0, 6.25, 2.385559, 7.60966, 4.226033, 5.0, 0.0, 5.0, 0.0, 3.75, 6.25, 3.633403, 2.844997, 3.75, 5.0, 5.0, 6.25, 5.0, 6.555647, 6.555647, 3.75, 2.5, 5.0, 5.0, 5.0, 5.0, 3.75, 5.0, 6.25, 2.5, 2.5, 2.5, 7.5, 5.0, 8.75, 1.25, 0.0, 0.0, 3.75, 7.5, 5.0, 3.75, 5.0, 5.0, 2.5, 3.75, 7.5, 7.5, 10.0, 1.25],
        y6:   [0.0, 1.1, 8.094061, 8.127979, 3.333333, 1.1, 2.233333, 3.333333, 3.333333, 6.666666, 3.333333, 3.333333, 3.333333, 0.0, 6.666666, 1.1, 1.1, 3.333333, 9.999998, 2.233299, 9.999998, 0.0, 0.0, 6.666666, 9.999998, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 2.233333, 1.1, 0.0, 0.0, 0.0, 0.0, 4.358243, 2.782771, 4.055463, 4.055463, 9.999998, 0.0, 9.999998, 1.1, 3.333333, 0.0, 0.0, 3.333333, 5.566663, 0.0, 0.0, 0.0, 3.333333, 0.0, 9.999998, 0.0, 0.0, 0.0, 3.333299, 9.999998, 3.333333, 9.999998, 0.0, 0.0, 3.333333, 6.666666, 6.666666, 6.34834, 6.666666, 3.333333],
        y7: [3.72636, 6.666666, 9.999998, 9.999998, 9.999998, 6.666666, 8.271257, 9.999998, 3.333333, 9.999998, 9.999998, 6.666666, 6.666666, 9.999998, 9.999998, 6.666666, 6.666666, 3.333333, 9.999998, 6.666666, 9.999998, 0.0, 3.333333, 9.999998, 7.351018, 4.696028, 6.666666, 3.177568, 8.118828, 0.0, 3.333333, 0.0, 3.333333, 3.333333, 7.827667, 6.666666, 3.314128, 4.429657, 6.164304, 4.938089, 6.666666, 9.999998, 6.666666, 6.666666, 0.0, 7.631891, 0.0, 9.556024, 6.666666, 6.666666, 6.666666, 6.666666, 6.666666, 9.999998, 0.0, 3.333333, 5.228375, 9.999998, 6.666666, 9.999998, 0.0, 0.0, 6.666666, 6.666666, 9.999998, 9.999998, 9.999998, 3.621989, 0.0, 6.666666, 6.666666, 9.999998, 6.666666, 9.999998, 0.0],
        y8: [3.333333, 0.736999, 8.211809, 4.615086, 6.666666, 0.3685, 1.485166, 6.666666, 3.333333, 10.0, 6.666666, 6.666666, 10.0, 0.0, 10.0, 6.666666, 0.3685, 3.333333, 10.0, 2.948164, 10.0, 0.0, 3.333333, 7.766666, 6.666666, 3.333333, 3.333333, 1.116666, 3.333333, 0.0, 3.333333, 0.0, 3.333333, 0.74437, 6.666666, 2.955702, 3.333333, 1.485166, 3.333333, 2.233333, 0.3685, 4.141377, 4.974739, 3.821796, 0.0, 6.666666, 0.0, 6.666666, 1.099999, 6.666666, 3.333333, 1.485166, 5.566663, 6.666666, 0.0, 3.333333, 0.0, 6.666666, 1.485166, 10.0, 0.0, 0.0, 2.948164, 3.333333, 10.0, 3.333333, 10.0, 3.333333, 0.0, 3.333333, 1.485166, 6.666666, 7.508044, 10.0, 0.0],
        x1: [4.442651, 5.384495, 5.961005, 6.285998, 5.863631, 5.533389, 5.308268, 5.347108, 5.521461, 5.828946, 5.916202, 5.398163, 6.622736, 5.204007, 5.509388, 5.26269, 4.70048, 5.209486, 5.916202, 6.523562, 6.238325, 5.976351, 5.631212, 6.033086, 6.196444, 4.248495, 5.141664, 4.174387, 4.382027, 4.290459, 4.934474, 3.850148, 5.181784, 5.062595, 4.691348, 4.248495, 5.56452, 4.727388, 4.143135, 4.317488, 5.141664, 4.488636, 4.615121, 3.850148, 3.970292, 3.78419, 3.806662, 4.532599, 5.117994, 5.049856, 5.393628, 4.477337, 5.257495, 5.379897, 5.298317, 4.859812, 4.969813, 6.011267, 5.075174, 6.736967, 5.225747, 4.025352, 4.234107, 4.644391, 4.418841, 4.26268, 4.875197, 4.189655, 4.521789, 4.65396, 4.477337, 5.337538, 6.12905, 5.003946, 4.488636],
        x2: [3.637586, 5.062595, 6.25575, 7.567863, 6.818924, 5.135798, 5.075174, 4.85203, 5.241747, 5.370638, 6.423247, 6.246107, 7.872074, 5.225747, 6.202536, 5.820083, 5.023881, 4.465908, 6.732211, 6.992096, 6.746412, 6.712956, 5.937536, 6.09357, 6.704414, 2.70805, 4.564348, 3.688879, 2.890372, 1.609438, 4.234107, 1.94591, 4.394449, 4.59512, 4.143135, 3.367296, 5.236442, 3.610918, 2.302585, 4.955827, 4.430817, 3.465736, 4.941642, 2.397895, 2.397895, 3.091042, 2.079442, 3.610918, 4.934474, 5.111988, 5.638355, 3.931826, 5.840642, 5.505332, 6.274762, 5.669881, 5.56452, 6.253829, 5.252273, 7.125283, 5.451038, 1.791759, 2.70805, 5.56452, 4.941642, 4.219508, 4.70048, 1.386294, 4.127134, 3.555348, 3.091042, 5.631212, 6.403574, 4.962845, 4.89784],
        x3: [2.557615, 3.568079, 5.224433, 6.267495, 4.573679, 3.89227, 3.316213, 4.263183, 4.115168, 4.446216, 3.791545, 4.535708, 4.906154, 4.561047, 4.586286, 3.948911, 4.394491, 4.510268, 5.829084, 6.424591, 5.741711, 5.948168, 5.686755, 4.611429, 5.475261, 1.74083, 2.255134, 3.046927, 1.711279, 1.001674, 1.418971, 2.345229, 3.167167, 3.83497, 2.255134, 3.217506, 2.677633, 1.418971, 1.418971, 4.249888, 3.046927, 2.013579, 2.255134, 1.74083, 1.050741, 2.113313, 2.137561, 1.587802, 3.83497, 4.38149, 4.169451, 2.474671, 5.001796, 3.299937, 4.38149, 3.537416, 4.510268, 5.001796, 5.350708, 6.330518, 3.167167, 2.657972, 2.474671, 3.046927, 3.380653, 4.368462, 3.83497, 1.418971, 2.113313, 1.881917, 1.987909, 3.491004, 5.001796, 3.976994, 2.867566]
      }
    end

    let(:obs_names) { %i(y1 y2 y3 y4 y5 y6 y7 y8 x1 x2 x3) }

    it do
      expect(Sem.calc_cov(data, obs_names)).to eq [[6.878565765765763], [6.251365921378376, 15.579816221768326], [5.838835415153152, 5.838625802392249, 10.764247277402086], [6.088642658864863, 9.508553366610547, 6.687936986190326, 11.218931776707034], [5.0638108147027046, 5.603072261467126, 4.939027086314185, 5.702058530355774, 6.825690082239644], [5.745826160972972, 9.38628929792764, 4.727396333470549, 7.442182070448498, 4.976804502412789, 11.375325091182104], [5.811943163072071, 7.53546231835126, 7.006434732295529, 7.487998778995061, 5.821366214021763, 6.748119029516425, 10.799371918682988], [5.671057616918921, 7.758213183766435, 5.639139066380677, 8.012646296505268, 5.339385921009472, 8.246829690300661, 7.5924331310824495, 10.533871682636216], [0.7343929760270267, 0.6194955320307779, 0.7868786780135141, 1.150461302755088, 1.0816259473946894, 0.8527889034159051, 0.9368373315369286, 1.102881273239664, 0.5371487292885415], [1.2733938771711715, 1.491272863569942, 1.5519350735879736, 2.240957049688002, 2.0637328341173613, 1.8054863446408282, 1.9955952244575004, 2.2342369637706088, 0.9903610805651824, 2.2821069870349127], [0.9114547437117116, 1.169813137249839, 1.0390795500083518, 1.838023253205387, 1.5834647589409292, 1.572066155923883, 1.625953500084368, 1.6921569383732282, 0.8234240165400466, 1.8060905962917435, 1.9760240969382776]]
    end
  end
end