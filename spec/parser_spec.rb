require File.expand_path '../spec_helper.rb', __FILE__

describe Sem::Parser do
  let(:data) do
    {:"b5ba6e23-15e2-4198-9edc-12d15b662fe5"=>[2, 1, 7, 8, 10, 7, 7, 7, 2, 10, 7, 7, 7, 7, 7, 7, 2, 1, 10, 7, 10, 1, 2, 7, 8, 6, 3, 2, 9, 6, 2, 2, 5, 5, 4, 6, 5, 5, 3, 4, 5, 5, 5, 5, 5, 7, 2, 8, 7, 7, 2, 3, 5, 6, 1, 1, 1, 7, 2, 7, 1, 1, 2, 6, 7, 5, 7, 4, 5, 2, 5, 7, 7, 10, 3], :"1f555b75-a601-459d-afef-f715d4ac2bb7"=>[0, 0, 8, 8, 3, 3, 3, 2, 3, 6, 3, 3, 3, 7, 9, 9, 3, 0, 9, 3, 9, 0, 0, 6, 9, 0, 0, 3, 0, 0, 0, 0, 0, 0, 9, 9, 4, 3, 4, 9, 9, 7, 6, 4, 4, 9, 0, 9, 0, 9, 0, 0, 3, 3, 0, 0, 0, 7, 0, 9, 0, 0, 0, 2, 9, 0, 9, 2, 0, 3, 9, 8, 7, 6, 3], :"1f8e3251-b081-4fad-a7eb-20c2fb782db3"=>[3, 3, 9, 9, 9, 6, 6, 9, 3, 9, 9, 6, 9, 9, 3, 9, 6, 3, 9, 3, 9, 0, 3, 9, 6, 5, 6, 6, 9, 6, 3, 0, 3, 9, 4, 9, 6, 6, 4, 6, 6, 6, 9, 0, 0, 7, 6, 9, 10, 6, 6, 5, 3, 9, 3, 4, 6, 9, 6, 9, 0, 0, 0, 6, 9, 6, 9, 9, 8, 6, 6, 9, 9, 9, 0], :"47f16bf0-5ff8-4654-9e69-da4023be1411"=>[0, 0, 9, 9, 6, 6, 6, 1, 3, 8, 6, 6, 6, 6, 10, 7, 6, 3, 10, 6, 10, 0, 3, 10, 6, 3, 3, 3, 3, 3, 3, 0, 3, 3, 6, 6, 3, 6, 5, 3, 1, 8, 6, 0, 0, 6, 3, 6, 0, 6, 3, 0, 2, 2, 0, 0, 0, 6, 4, 10, 0, 0, 0, 2, 10, 0, 10, 0, 0, 3, 3, 6, 6, 10, 0], :"a2d4e1b7-9610-4163-b7cf-1e014e0e5a62"=>[1, 6, 8, 8, 7, 6, 5, 6, 6, 8, 8, 8, 7, 7, 7, 7, 5, 1, 8, 7, 10, 2, 2, 7, 8, 0, 6, 2, 7, 4, 5, 0, 5, 0, 3, 6, 3, 2, 3, 5, 5, 6, 5, 6, 6, 3, 2, 5, 5, 5, 5, 3, 5, 6, 2, 2, 2, 7, 5, 8, 1, 0, 0, 3, 7, 5, 3, 5, 5, 2, 3, 7, 7, 10, 1], :"dfd84eed-7c85-442e-ba06-fc4684e191dc"=>[0, 1, 8, 8, 3, 1, 2, 3, 3, 6, 3, 3, 3, 0, 6, 1, 1, 3, 9, 2, 9, 0, 0, 6, 9, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 2, 1, 0, 0, 0, 0, 4, 2, 4, 4, 9, 0, 9, 1, 3, 0, 0, 3, 5, 0, 0, 0, 3, 0, 9, 0, 0, 0, 3, 9, 3, 9, 0, 0, 3, 6, 6, 6, 6, 3], :"b1fe035e-4a69-4e86-b93d-6eb3edc03bd5"=>[3, 6, 9, 9, 9, 6, 8, 9, 3, 9, 9, 6, 6, 9, 9, 6, 6, 3, 9, 6, 9, 0, 3, 9, 7, 4, 6, 3, 8, 0, 3, 0, 3, 3, 7, 6, 3, 4, 6, 4, 6, 9, 6, 6, 0, 7, 0, 9, 6, 6, 6, 6, 6, 9, 0, 3, 5, 9, 6, 9, 0, 0, 6, 6, 9, 9, 9, 3, 0, 6, 6, 9, 6, 9, 0], :"bebbbdfd-c7f6-40b7-a37d-d7eb1b41ac49"=>[3, 0, 8, 4, 6, 0, 1, 6, 3, 10, 6, 6, 10, 0, 10, 6, 0, 3, 10, 2, 10, 0, 3, 7, 6, 3, 3, 1, 3, 0, 3, 0, 3, 0, 6, 2, 3, 1, 3, 2, 0, 4, 4, 3, 0, 6, 0, 6, 1, 6, 3, 1, 5, 6, 0, 3, 0, 6, 1, 10, 0, 0, 2, 3, 10, 3, 10, 3, 0, 3, 1, 6, 7, 10, 0], :"4ad8574c-038d-48f0-93c3-102baa48152a"=>[4, 5, 5, 6, 5, 5, 5, 5, 5, 5, 5, 5, 6, 5, 5, 5, 4, 5, 5, 6, 6, 5, 5, 6, 6, 4, 5, 4, 4, 4, 4, 3, 5, 5, 4, 4, 5, 4, 4, 4, 5, 4, 4, 3, 3, 3, 3, 4, 5, 5, 5, 4, 5, 5, 5, 4, 4, 6, 5, 6, 5, 4, 4, 4, 4, 4, 4, 4, 4, 4, 4, 5, 6, 5, 4], :"83e9e10d-2fbb-4315-94dc-11d15b03cc75"=>[3, 5, 6, 7, 6, 5, 5, 4, 5, 5, 6, 6, 7, 5, 6, 5, 5, 4, 6, 6, 6, 6, 5, 6, 6, 2, 4, 3, 2, 1, 4, 1, 4, 4, 4, 3, 5, 3, 2, 4, 4, 3, 4, 2, 2, 3, 2, 3, 4, 5, 5, 3, 5, 5, 6, 5, 5, 6, 5, 7, 5, 1, 2, 5, 4, 4, 4, 1, 4, 3, 3, 5, 6, 4, 4], :"fbf89ce6-a128-491c-8604-3372278729a6"=>[2, 3, 5, 6, 4, 3, 3, 4, 4, 4, 3, 4, 4, 4, 4, 3, 4, 4, 5, 6, 5, 5, 5, 4, 5, 1, 2, 3, 1, 1, 1, 2, 3, 3, 2, 3, 2, 1, 1, 4, 3, 2, 2, 1, 1, 2, 2, 1, 3, 4, 4, 2, 5, 3, 4, 3, 4, 5, 5, 6, 3, 2, 2, 3, 3, 4, 3, 1, 2, 1, 1, 3, 5, 3, 2]}
  end

  let(:name_converter) do
    name_converter = Sem::NameConverter.new(data)
    name_converter.to_tmp_names(data)
    name_converter
  end

  let(:parser) { Sem::Parser.new(name_converter) }

  let(:r_out_s) do
<<"EOS"
Latent Variables:
                   Estimate  Std.Err  Z-value  P(>|z|)   Std.lv  Std.all
  lat0 =~
    obs0              1.000                               1.560    0.839
    obs1              1.230    0.977    1.259    0.208    1.919    0.761
    obs2              0.927    0.850    1.090    0.276    1.446    0.687
    obs3              1.271    0.842    1.509    0.131    1.983    0.856
  lat1 =~
    obs8              1.000                               0.478    0.858
    obs9              2.119    1.186    1.786    0.074    1.013    0.942
    obs10             1.795    1.118    1.606    0.108    0.858    0.867
  lat2 =~
    obs4              1.000                               1.411    0.784
    obs5              1.206    0.997    1.210    0.226    1.701    0.782
    obs6              1.216    0.958    1.269    0.204    1.715    0.812
    obs7              1.349    1.028    1.312    0.190    1.903    0.833
EOS
  end

  let(:r_out_a) { r_out_s.split("\n") }

  describe 'parser' do
    it do
      result_lat = {:"7a000eca-92f1-412c-a620-4c63c53e4558"=>[{:name=>:"b5ba6e23-15e2-4198-9edc-12d15b662fe5", "Estimate"=>"1.000", "Std.Err"=>"1.560", "Z-value"=>"0.839"}, {:name=>:"1f555b75-a601-459d-afef-f715d4ac2bb7", "Estimate"=>"1.230", "Std.Err"=>"0.977", "Z-value"=>"1.259", "P(>|z|)"=>"0.208", "Std.lv"=>"1.919", "Std.all"=>"0.761"}, {:name=>:"1f8e3251-b081-4fad-a7eb-20c2fb782db3", "Estimate"=>"0.927", "Std.Err"=>"0.850", "Z-value"=>"1.090", "P(>|z|)"=>"0.276", "Std.lv"=>"1.446", "Std.all"=>"0.687"}, {:name=>:"47f16bf0-5ff8-4654-9e69-da4023be1411", "Estimate"=>"1.271", "Std.Err"=>"0.842", "Z-value"=>"1.509", "P(>|z|)"=>"0.131", "Std.lv"=>"1.983", "Std.all"=>"0.856"}], :"056dce8e-385b-463e-a279-dd1c041c8d5c"=>[{:name=>:"4ad8574c-038d-48f0-93c3-102baa48152a", "Estimate"=>"1.000", "Std.Err"=>"0.478", "Z-value"=>"0.858"}, {:name=>:"83e9e10d-2fbb-4315-94dc-11d15b03cc75", "Estimate"=>"2.119", "Std.Err"=>"1.186", "Z-value"=>"1.786", "P(>|z|)"=>"0.074", "Std.lv"=>"1.013", "Std.all"=>"0.942"}, {:name=>:"fbf89ce6-a128-491c-8604-3372278729a6", "Estimate"=>"1.795", "Std.Err"=>"1.118", "Z-value"=>"1.606", "P(>|z|)"=>"0.108", "Std.lv"=>"0.858", "Std.all"=>"0.867"}], :"1b116062-0ed1-423b-bdb9-92d68005fe69"=>[{:name=>:"a2d4e1b7-9610-4163-b7cf-1e014e0e5a62", "Estimate"=>"1.000", "Std.Err"=>"1.411", "Z-value"=>"0.784"}, {:name=>:"dfd84eed-7c85-442e-ba06-fc4684e191dc", "Estimate"=>"1.206", "Std.Err"=>"0.997", "Z-value"=>"1.210", "P(>|z|)"=>"0.226", "Std.lv"=>"1.701", "Std.all"=>"0.782"}, {:name=>:"b1fe035e-4a69-4e86-b93d-6eb3edc03bd5", "Estimate"=>"1.216", "Std.Err"=>"0.958", "Z-value"=>"1.269", "P(>|z|)"=>"0.204", "Std.lv"=>"1.715", "Std.all"=>"0.812"}, {:name=>:"bebbbdfd-c7f6-40b7-a37d-d7eb1b41ac49", "Estimate"=>"1.349", "Std.Err"=>"1.028", "Z-value"=>"1.312", "P(>|z|)"=>"0.190", "Std.lv"=>"1.903", "Std.all"=>"0.833"}]}
      expect(parser.parse_vars(r_out_a)).to eq result_lat
    end
  end
end