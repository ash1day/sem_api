<!DOCTYPE html>
<meta charset="utf-8">
<style>

/* for directed-forced graph */
.links line {
  stroke: #999;
  stroke-opacity: 0.6;
}

.nodes circle {
  stroke: #fff;
  stroke-width: 1.5px;
}

/* for heatmap */
rect.bordered {
  stroke: #E6E6E6;
  stroke-width:2px;
}

text.mono {
  font-size: 9pt;
  font-family: Consolas, courier;
  fill: #aaa;
}

text.axis-workweek {
  fill: #000;
}

text.axis-worktime {
  fill: #000;
}

</style>
<svg width="960" height="600"></svg>
<div id="myDiv"></div>
<script src="https://d3js.org/d3.v4.min.js"></script>
<script src="https://cdn.plot.ly/plotly-latest.min.js"></script>
<script>

var payload = {
  nobs: 75,
  obs_names: ['y1', 'y2', 'y3', 'y4', 'y5', 'y6', 'y7', 'y8', 'x1', 'x2', 'x3'],
  cov: [
    [6.8785658],
    [6.2513659, 15.5798162],
    [5.8388354, 5.8386258, 10.7642473],
    [6.0886427, 9.5085534, 6.687937, 11.218932],
    [5.0638108, 5.6030723, 4.9390271, 5.702059, 6.82569],
    [5.7458262, 9.3862893, 4.7273963, 7.442182, 4.976805, 11.3753251],
    [5.8119432, 7.5354623, 7.0064347, 7.487999, 5.821366, 6.748119, 10.7993719],
    [5.6710576, 7.7582132, 5.6391391, 8.012646, 5.339386, 8.2468297, 7.5924331, 10.533872],
    [0.734393, 0.6194955, 0.7868787, 1.150461, 1.081626, 0.8527889, 0.9368373, 1.102881, 0.5371487],
    [1.2733939, 1.4912729, 1.5519351, 2.240957, 2.063733, 1.8054863, 1.9955952, 2.234237, 0.9903611, 2.282107],
    [0.9114547, 1.1698131, 1.0390796, 1.838023, 1.583465, 1.5720662, 1.6259535, 1.692157, 0.823424, 1.8060906, 1.9760241]
  ],
  model: {
    latent_variable: {
      ind60: ['x1', 'x2', 'x3'],
      dem60: ['y1', 'y2', 'y3', 'y4'],
      dem65: ['y5', 'y6', 'y7', 'y8']
    },
    regression: {
      dem60: ['ind60'],
      dem65: ['ind60', 'dem60']
    },
    covariance: {
      y1: ['y5'],
      y2: ['y4', 'y6'],
      y3: ['y7'],
      y4: ['y8'],
      y6: ['y8']
    }
  }
}

fetch('http://localhost:4567/sem', {
  method: 'post',
  headers: { 'content-type': 'application/json' },
  body: JSON.stringify(payload),
  credentials: 'cors',
  chache: 'force cache'
}).then(function(response) {
  return response.json()
}).then(function(json) {
  heatmap(json)
  main(json)
})

function build_matrix(json) {
  raw_matrix = {}

  names = json.obs_names.sort()
  len   = names.length

  for (var row_name of json.obs_names) {
    raw_matrix[row_name] = {}
    for (var column_name of json.obs_names) {
      raw_matrix[row_name][column_name] = 0 // 0でいいのか?
    }

    // 分散
    raw_matrix[row_name][row_name] = json.variances[row_name].Estimate
  }

  // 共分散
  for (var row_name in json.covariances) {
    for (co_obj of json.covariances[row_name]) {
      raw_matrix[row_name][co_obj.name] = co_obj.Estimate
      raw_matrix[co_obj.name][row_name] = co_obj.Estimate
    }
  }

  matrix = []

  for (i = 0; i < len; i++) {
    matrix[i] = []
    for (j = 0; j < len; j++) {
      matrix[i][j] = raw_matrix[names[i]][names[j]]
    }
  }

  return { names: names, matrix: matrix }
}

function build(json) {
  var nodes = [], links = []

  // 潜在変数の定義式より、ノードとリンクを作成
  for (var left_var in json.latent_variables) {
    nodes.push({ id: left_var, group: 1 })
    for (right_var of json.latent_variables[left_var]) {
      nodes.push({ id: right_var.name, group: 2 })
      links.push({ source: left_var, target: right_var.name, value: right_var['Estimate'] })
    }
  }

  // 回帰の式からリンクを作成
  for (var left_var in json.regressions) {
    for (right_var of json.regressions[left_var]) {
      links.push({ source: left_var, target: right_var.name, value: right_var['Estimate'] })
    }
  }

  return {
    nodes: nodes,
    links: links
  }
}

function main(json) {
  var graph = build(json)

  var svg = d3.select('svg'),
      width = +svg.attr('width'),
      height = +svg.attr('height')

  // TODO: いい感じの矢印に
  svg.append('defs').append('marker')
    .attr('id', 'arrowhead')
    .attr('refX', 4.5)
    .attr('refY', 2)
    .attr('markerWidth', 5)
    .attr('markerHeight', 4)
    .attr('orient', 'auto')
    .append('path')
        .attr('d', 'M 0,0 V 4 L3,2 Z')
        .attr('fill', 'steelblue')

  var color = d3.scaleOrdinal(d3.schemeCategory20)

  var simulation = d3.forceSimulation()
      .force('link', d3.forceLink().distance(50).id(function(d) { return d.id }))
      .force('charge', d3.forceManyBody())
      .force('center', d3.forceCenter(width / 2, height / 2))

  var link = svg.append('g')
      .attr('class', 'links')
    .selectAll('line')
    .data(graph.links)
    .enter().append('line')
      .attr('marker-end', 'url(#arrowhead)')
      .attr('stroke-width', function(d) { return Math.sqrt(d.value * 10) })

  var node = svg.selectAll('.node')
      .data(graph.nodes)
    .enter().append('g')
      .attr('class', 'node')

  node.append('circle')
      .attr('r', 6)
      .attr('fill', function(d) { return color(d.group) })

  node.append('text')
      .attr('dx', 12)
      .attr('dy', '.35em')
      .text(function(d) { return d.id })

  simulation
      .nodes(graph.nodes)
      .on('tick', ticked)

  simulation.force('link')
      .links(graph.links)

  function ticked() {
    link.attr('x1', function(d) { return d.source.x })
        .attr('y1', function(d) { return d.source.y })
        .attr('x2', function(d) { return d.target.x })
        .attr('y2', function(d) { return d.target.y })

    node.attr('transform', function(d) { return 'translate(' + d.x + ',' + d.y + ')' })
  }
}


function heatmap(json){
  data = build_matrix(json)
  names = data.names
  matrix = data.matrix

  var data = [
    {
      x: names,
      y: names.concat().reverse(),
      z: matrix.reverse(),
      type: 'heatmap'
    }
  ]

  var layout = {
    title: 'Covariances matrix',
    annotations: [],
    xaxis: {
      ticks: '',
      side: 'top'
    },
    yaxis: {
      ticks: '',
      ticksuffix: ' ',
      autosize: false
    },
    width: 500,
    height: 500
  }

  Plotly.newPlot('myDiv', data, layout);
}

</script>